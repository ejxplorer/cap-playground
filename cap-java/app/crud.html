<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Person CRUD Test</title>
</head>
<body>
    <h1>Person CRUD Test</h1>

    <div>
        <h2>Person Form</h2>
        <label>ID: <input type="text" id="id" placeholder="자동 생성" readonly></label><br>
        <label>Name: <input type="text" id="name"></label><br>
        <label>Age: <input type="text" id="age"></label><br>
        <label>Address: <input type="text" id="address"></label><br>
        <label>Weight: <input type="number" id="weight"></label><br><br>

        <button onclick="createPerson()">Create (PersonDetail)</button>
        <button onclick="updatePerson()">Update (Person)</button>
    </div>

    <div>
        <h2>Person List</h2>
        <table border="1" id="PersonTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Age</th>
                    <th>Address</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="PersonBody"></tbody>
        </table>
    </div>

    <script>
        // CAP Node.js와 CAP Java 모두 기본 OData 경로가 /odata/v4/service_name 일 가능성이 높습니다.
        const BASE_URL = '/odata/v4/PersonService'; 

        // CREATE - PersonDetail
        async function createPerson() {
            const data = {
                name: document.getElementById('name').value,
                age: document.getElementById('age').value,
                address: document.getElementById('address').value,
                weight: parseInt(document.getElementById('weight').value)
            };

            try {
                // Note: PersonDetail 엔티티에 POST
                const response = await fetch(`${BASE_URL}/PersonDetail`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    console.log('Person created successfully!', result);
                    readPerson();
                    clearForm();
                } else {
                     console.error('Error creating Person:', result);
                     alert('Error creating Person: ' + (result.error ? result.error.message : 'Unknown error'));
                }
            } catch (error) {
                console.error('Fetch error: ', error.message);
                alert('Fetch error: ' + error.message);
            }
        }

        // READ - Person
        async function readPerson() {
            try {
                // Note: Person projection에 GET (weight 제외)
                const response = await fetch(`${BASE_URL}/Person`);
                
                const result = await response.json();
                
                // Update table
                const tbody = document.getElementById('PersonBody');
                tbody.innerHTML = '';
                
                if (result.value && result.value.length > 0) {
                    result.value.forEach(person => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td>${person.ID}</td>
                            <td>${person.name}</td>
                            <td>${person.age}</td>
                            <td>${person.address}</td>
                            <td>
                                <button onclick='selectPerson("${person.ID}")'>Select</button>
                                <button onclick='deletePerson("${person.ID}")'>Delete</button>
                            </td>
                        `;
                    });
                }
            } catch (error) {
                console.error('Fetch error: ', error.message);
            }
        }

        // UPDATE - Person
        async function updatePerson() {
            const id = document.getElementById('id').value;
            
            if (!id) {
                alert('Please select a person or enter ID');
                return;
            }

            const data = {
                name: document.getElementById('name').value,
                age: document.getElementById('age').value,
                address: document.getElementById('address').value,
                // weight도 업데이트하려면 포함 (Person projection의 UPDATE 핸들러에서 처리됨)
                weight: parseInt(document.getElementById('weight').value)
            };
            
            // OData에서 PATCH는 모든 필드를 보내지 않아도 됩니다. 값이 있는 필드만 보냅니다.
            const patchData = {};
            if (data.name) patchData.name = data.name;
            if (data.age) patchData.age = data.age;
            if (data.address) patchData.address = data.address;
            if (!isNaN(data.weight)) patchData.weight = data.weight;

            try {
                // Note: PersonDetail 엔티티에 PATCH (ID로 직접 접근)
                const response = await fetch(`${BASE_URL}/PersonDetail(ID=${id})`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(patchData) // PATCH는 변경된 데이터만 보냄
                });

                if (response.ok) {
                    console.log('Person updated successfully!');
                    readPerson();
                    clearForm();
                } else {
                    const result = await response.json();
                    console.error('Error updating Person:', result);
                    alert('Error updating Person: ' + (result.error ? result.error.message : 'Unknown error'));
                }
            } catch (error) {
                console.error('Fetch error: ', error.message);
                alert('Fetch error: ' + error.message);
            }
        }

        // DELETE - Person
        async function deletePerson(id) {
            const personId = id || document.getElementById('id').value;
            
            if (!personId) {
                alert('Please select a person or enter ID');
                return;
            }

            if (!confirm('Are you sure you want to delete this person?')) {
                return;
            }

            try {
                // Note: PersonDetail 엔티티에 DELETE
                const response = await fetch(`${BASE_URL}/PersonDetail(ID=${personId})`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('Person deleted successfully!');
                    readPerson();
                    clearForm();
                } else {
                    const result = await response.json();
                    console.error('Error deleting Person:', result);
                    alert('Error deleting Person: ' + (result.error ? result.error.message : 'Unknown error'));
                }
            } catch (error) {
                console.error('Fetch error: ', error.message);
                alert('Fetch error: ' + error.message);
            }
        }


        async function selectPerson(id) {
            try {
                // Note: PersonDetail 엔티티에서 전체 필드 조회
                const response = await fetch(`${BASE_URL}/PersonDetail(ID=${id})`);
                const person = await response.json();
                
                if (response.ok) {
                    document.getElementById('id').value = person.ID;
                    document.getElementById('name').value = person.name;
                    document.getElementById('age').value = person.age;
                    document.getElementById('address').value = person.address;
                    document.getElementById('weight').value = person.weight;
                }
            } catch (error) {
                console.error('Fetch error: ', error.message);
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('id').value = '';
            document.getElementById('name').value = '';
            document.getElementById('age').value = '';
            document.getElementById('address').value = '';
            document.getElementById('weight').value = '';
        }

        // Load data on page load
        window.onload = async function() {
            readPerson();
        };
    </script>
</body>
</html>