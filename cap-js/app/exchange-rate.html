<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exchange Rate</title>
    <link href="../style/exchangerate.css" rel="stylesheet" />
</head>
<body>
    <h1>환율 정보</h1>
    
    <button id="updateBtn" onclick="updateExchangeRate()">환율 업데이트</button>
    
    <div id="message"></div>
    
    <table id="exchangeTable">
        <thead>
            <tr>
                <th>통화코드</th>
                <th>통화명</th>
                <th>매매기준율</th>
                <th>송금 보낼때</th>
                <th>송금 받을때</th>
                <th>현찰 사실때</th>
                <th>현찰 파실때</th>
                <th>업데이트 시간</th>
            </tr>
        </thead>
        <tbody id="exchangeBody">
            <tr>
                <td colspan="8" class="loading">데이터를 불러오는 중...</td>
            </tr>
        </tbody>
    </table>

    <script>
        const BASE_URL = '/odata/v4/exchange-rate';

        // 초기 데이터 로드
        async function readExchangeRate() {
            try {
                const response = await fetch(`${BASE_URL}/ExchangeRate`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Read data:', result);
                
                renderTable(result.value || []);
            } catch (error) {
                console.error('Error reading data:', error);
                showMessage('데이터를 불러오는데 실패했습니다: ' + error.message, 'error');
            }
        }

        async function updateExchangeRate() {
            const btn = document.getElementById('updateBtn');
            btn.disabled = true;
            btn.textContent = '업데이트 중...';
            showMessage('외부 API에서 데이터를 가져오는 중...', 'loading');

            try {
                // fetchData 호출
                const response = await fetch(`${BASE_URL}/fetchData`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // 성공하면 데이터 다시 조회
                await readExchangeRate();
                showMessage('환율 정보가 성공적으로 업데이트되었습니다!', 'success');
                
            } catch (error) {
                console.error('Error updating data:', error);
                showMessage('환율 업데이트에 실패했습니다: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '환율 업데이트';
            }
        }

        // 테이블 렌더링
        function renderTable(data) {
            const tbody = document.getElementById('exchangeBody');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">데이터가 없습니다.</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.CUR_UNIT || '-'}</td>
                    <td>${item.CUR_NM || '-'}</td>
                    <td>${formatNumber(item.DEAL_BAS_R)}</td>
                    <td>${formatNumber(item.TTS)}</td>
                    <td>${formatNumber(item.TTB)}</td>
                    <td>${formatNumber(item.BKPR)}</td>
                    <td>${formatNumber(item.YY_EFEE_R)}</td>
                    <td>${formatDateTime(item.UPDATE_AT)}</td>
                `;
            });
        }

        // 숫자 포맷팅
        function formatNumber(value) {
            if (!value || value === '-') return '-';
            const num = parseFloat(value.replace(/,/g, ''));
            return isNaN(num) ? value : num.toLocaleString('ko-KR');
        }

        // 날짜 포맷팅
        function formatDateTime(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('ko-KR');
        }

        // 메시지 표시
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = type;
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.textContent = '';
                    messageDiv.className = '';
                }, 3000);
            }
        }

        // 페이지 로드 시 초기 데이터 로드
        window.onload = function() {
            readExchangeRate();
        };
    </script>
</body>
</html>